<!DOCTYPE html>
<html>
  <!-- 
==References==
Server-side:
* http://docs.ros.org/indigo/api/roswww/html/
* http://wiki.ros.org/web_video_server
* http://wiki.ros.org/rosbridge_suite/Tutorials/RunningRosbridge

Client-side:
* http://wiki.ros.org/roslibjs/Tutorials/BasicRosFunctionality
* https://getbootstrap.com/docs/4.0/getting-started/introduction/
* https://getbootstrap.com/docs/4.0/layout/grid/
-->

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/dashboard.css" />

    <title>Laboratoire S5-APP1</title>
  </head>

  <body>
    <!-- Menu BEGIN-->
    <div class="collapse" id="navbarToggleExternalContent">
      <div class="bg-dark p-4">
        <h4 class="text-white">Configuration</h4>
        <h6 class="text-white">ROS Master IP:</h6>
        <label for="MasterIP"></label>
        <input
          type="text"
          placeholder="10.42.0.1 or 127.0.0.1"
          id="MasterIP"
          style="width: 50%; font-size: 17px; border-radius: 5px; padding: 5px"
        />
        <br />
        <button type="button" class="btn btn-light m-1" onclick="connectROS()">
          Connectez
        </button>
      </div>
    </div>

    <nav class="navbar navbar-dark bg-dark">
      <div>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarToggleExternalContent"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <label class="text-white h4">Racecar</label>
      </div>
    </nav>
    <!-- Menu END-->

    <!-- Main layout BEGIN-->
    <div class="container-fluid m-4">
      <div class="row">
        <div class="col-md-4 col-sm-12">
          <h1>Status</h1>

          <textarea
            name="statut_output"
            id="statut_output"
            cols="100%"
            rows="10"
            readonly
            style="background: lightgrey; max-width: 90%"
          ></textarea>

          <button type="button" class="btn btn-dark" onclick="eraseAll()">
            Effacez
          </button>

          <h1>Contrôle</h1>

          <button
            id="forward"
            type="button"
            class="btn btn-dark m-1"
            disabled
            onclick="forward()"
          >
            Avancez
          </button>
          <button
            id="stop"
            type="button"
            class="btn btn-dark m-1"
            disabled
            onclick="stop()"
          >
            Arrêtez
          </button>
        </div>
        <div class="col-md-1"></div>
        <div class="col-md-7 col-sm-12">
          <h1>Caméra</h1>

          <img
            style="width: 90%"
            src="http://localhost:8080/stream?topic=/racecar/raspicam_node/image&type=ros_compressed"
            alt="racecar_video_stream"
          />
        </div>
      </div>
    </div>
    <!-- Main layout END-->

    <!-- JavaScript, import frameworks -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.3.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/roslib.min.js"></script>
    <!-- rosbridge -->

    <!-- Custom scripts -->
    <script>
      // Define some global variables
      var rbServer = null;
      var cmdVelTopic = null;

      //Some initializations after the page has been shown
      $(document).ready(function () {
        document.getElementById("log").value = "Default text\n";
      });

      // Define some functions
      function connectROS() {
        // This function connects to the rosbridge server

        rbServer = new ROSLIB.Ros({
          // Assuming ros server IP is 10.42.0.1
          url: "ws://" + document.getElementById("MasterIP").value + ":9090",
        });

        rbServer.on("connection", function () {
          console.log("Connected to websocket server.");
          addInfo("Connecté au Racecar!");
          document.getElementById("forward").disabled = false;
          document.getElementById("stop").disabled = false;

          // These lines create a topic object as defined by roslibjs
          cmdVelTopic = new ROSLIB.Topic({
            ros: rbServer,
            name: "/racecar/cmd_vel_abtr_2",
            messageType: "geometry_msgs/Twist",
          });
        });

        rbServer.on("error", function (error) {
          console.log("Error connecting to websocket server: ", error);
          addInfo("Erreur de connection avec le Racecar!");
          document.getElementById("forward").disabled = true;
          document.getElementById("stop").disabled = true;
        });

        rbServer.on("close", function () {
          console.log("Connection to websocket server closed.");
          addInfo("Connexion fermé.");
          document.getElementById("forward").disabled = true;
          document.getElementById("stop").disabled = true;
        });
      }

      // These lines create a message that conforms to the structure of the Twist defined in our ROS installation
      // It initalizes all properties to zero. They will be set to appropriate values before we publish this message.
      var twist = new ROSLIB.Message({
        linear: {
          x: 0.0,
          y: 0.0,
          z: 0.0,
        },
        angular: {
          x: 0.0,
          y: 0.0,
          z: 0.0,
        },
      });

      //Publishing loop cmd_vel at 5 Hz
      setInterval(function () {
        if (cmdVelTopic != null) {
          cmdVelTopic.publish(twist);
        }
      }, 200);

      function addInfo(arg) {
        document.getElementById("statut_output").innerHTML += arg + "\n";
      }

      function eraseAll() {
        document.getElementById("statut_output").innerHTML = "";
      }

      function forward() {
        addInfo("Avancez");
        twist.linear.x = 1.0;
      }

      function stop() {
        addInfo("Arrêtez");
        twist.linear.x = 0.0;
      }
    </script>
  </body>
</html>
